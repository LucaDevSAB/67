-- Gica Hub - Advanced Server Hopping & Pet Finder
-- Automatisches Server-Hopping bis Target-Pets gefunden werden

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

-- Konfiguration
local CONFIG = {
    TARGET_PETS = {
        "Los Bros",
        "Los Combinasionas",
        "Spaghetti Tualetti",
        "La Extinct Grande",
        "La Grande Combinasion",
        "Las Sis"
    },
    GAME_ID = game.PlaceId,
    CHECK_DELAY = 2,
    HOP_DELAY = 1,
    RETRY_DELAY = 3,
    MAX_RETRIES_PER_SERVER = 3
}

-- Logging
local function log(message, level)
    level = level or "INFO"
    local timestamp = os.date("%H:%M:%S")
    print(string.format("[%s] [%s] %s", timestamp, level, message))
end

-- Pet Detection - Sucht nach mehreren Target-Pets
local function checkForPets(targetPetNames)
    log("Prüfe Server auf Target-Pets...")
    
    -- Option 1: Suche in Workspace nach Pet-Namen
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Model") or obj:IsA("Folder") then
            for _, targetName in ipairs(targetPetNames) do
                if obj.Name == targetName or string.find(obj.Name, targetName) then
                    log("★ " .. targetName .. " GEFUNDEN in Workspace!", "SUCCESS")
                    return true, targetName, obj
                end
            end
        end
    end
    
    -- Option 2: Suche in allen Spielern
    for _, player in pairs(Players:GetPlayers()) do
        if player.Character then
            for _, obj in pairs(player.Character:GetDescendants()) do
                for _, targetName in ipairs(targetPetNames) do
                    if obj.Name == targetName or string.find(obj.Name, targetName) then
                        log(string.format("★ %s bei Spieler %s gefunden!", targetName, player.Name), "SUCCESS")
                        return true, targetName, obj
                    end
                end
            end
        end
        
        -- Prüfe auch Backpack/PlayerGui
        if player.Backpack then
            for _, obj in pairs(player.Backpack:GetDescendants()) do
                for _, targetName in ipairs(targetPetNames) do
                    if obj.Name == targetName or string.find(obj.Name, targetName) then
                        log(string.format("★ %s im Backpack von %s gefunden!", targetName, player.Name), "SUCCESS")
                        return true, targetName, obj
                    end
                end
            end
        end
    end
    
    -- Option 3: Prüfe ReplicatedStorage
    if game:GetService("ReplicatedStorage") then
        for _, obj in pairs(game:GetService("ReplicatedStorage"):GetDescendants()) do
            for _, targetName in ipairs(targetPetNames) do
                if obj.Name == targetName or string.find(obj.Name, targetName) then
                    log("★ " .. targetName .. " in ReplicatedStorage gefunden!", "SUCCESS")
                    return true, targetName, obj
                end
            end
        end
    end
    
    return false, nil, nil
end

-- Server-Liste - ALLE Server (auch volle)
local function getAvailableServers()
    local servers = {}
    local cursor = ""
    local page = 1
    
    repeat
        local success, result = pcall(function()
            local url = string.format(
                "https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Desc&limit=100&cursor=%s",
                CONFIG.GAME_ID,
                cursor
            )
            return HttpService:JSONDecode(game:HttpGet(url))
        end)
        
        if success and result then
            for _, server in pairs(result.data) do
                -- Nur aktuellen Server überspringen, ALLE anderen versuchen (auch volle)
                if server.id ~= game.JobId then
                    table.insert(servers, server)
                end
            end
            
            cursor = result.nextPageCursor or ""
            page = page + 1
            
            if cursor == "" then
                break
            end
            
            wait(0.5)
        else
            break
        end
    until page > 5 or cursor == ""
    
    return servers
end

-- Server-Hopping mit Retry-Logik
local function serverHopWithRetry(statusCallback)
    log("Hole Serverliste...", "INFO")
    local servers = getAvailableServers()
    
    if #servers == 0 then
        log("Keine Server gefunden - warte und versuche erneut...", "WARNING")
        if statusCallback then
            statusCallback("Keine Server verfügbar\nWarte " .. CONFIG.RETRY_DELAY .. "s...")
        end
        wait(CONFIG.RETRY_DELAY)
        return serverHopWithRetry(statusCallback) -- Rekursiv nochmal versuchen
    end
    
    log(string.format("✓ %d Server gefunden (inkl. voller Server)", #servers), "SUCCESS")
    
    local teleportSuccessful = false
    
    -- Probiere jeden Server durch
    for i, targetServer in ipairs(servers) do
        local serverStatus = "OK"
        if targetServer.playing >= targetServer.maxPlayers then
            serverStatus = "VOLL"
        end
        
        log(string.format("Versuche Server %d/%d [%s]: %s (%d/%d Spieler)", 
            i,
            #servers,
            serverStatus,
            targetServer.id:sub(1, 8), 
            targetServer.playing, 
            targetServer.maxPlayers
        ))
        
        if statusCallback then
            statusCallback(string.format("Server %d/%d [%s]\nSpieler: %d/%d", 
                i, #servers, serverStatus, targetServer.playing, targetServer.maxPlayers))
        end
        
        -- Teleport-Versuch mit Error-Handling
        local teleportFailed = false
        
        -- Event-Handler für Teleport-Fehler (einmalig für diesen Versuch)
        local failConnection = TeleportService.TeleportInitFailed:Connect(function(...)
            log("Teleport fehlgeschlagen (Server voll oder Fehler)", "ERROR")
            teleportFailed = true
        end)
        
        -- Versuche Teleport
        local success, err = pcall(function()
            TeleportService:TeleportToPlaceInstance(
                CONFIG.GAME_ID,
                targetServer.id,
                LocalPlayer
            )
        end)
        
        if not success then
            -- Direkt Fehler beim Teleport-Aufruf
            log("Teleport-Error: " .. tostring(err), "ERROR")
            failConnection:Disconnect()
            wait(CONFIG.HOP_DELAY)
            -- Weiter zum nächsten Server in der Schleife
        else
            -- Teleport initiiert - warte auf Erfolg oder Fehler
            wait(2)
            failConnection:Disconnect()
            
            if not teleportFailed then
                -- Erfolgreich! (wird zum neuen Server teleportiert)
                log("✓ Teleport erfolgreich! Wechsle zu neuem Server...", "SUCCESS")
                teleportSuccessful = true
                break
            else
                -- Fehlgeschlagen - nächster Server
                log("Server-Join fehlgeschlagen - nächster Versuch...", "WARNING")
                wait(CONFIG.HOP_DELAY)
            end
        end
    end
    
    -- Nur weiter versuchen, wenn KEIN erfolgreicher Teleport
    if not teleportSuccessful then
        log("Alle Server durchprobiert - hole neue Liste...", "WARNING")
        wait(CONFIG.RETRY_DELAY)
        return serverHopWithRetry(statusCallback) -- Neue Serverliste holen und nochmal versuchen
    end
    
    -- Bei erfolgreichem Teleport: Funktion beenden (Script wird auf neuem Server neu geladen)
end

-- Haupt-Loop - Läuft bis Pet gefunden
local function startGicaHub(statusCallback)
    log("=== Gica Hub gestartet ===")
    log("Target-Pets: " .. table.concat(CONFIG.TARGET_PETS, ", "))
    log("Game ID: " .. CONFIG.GAME_ID)
    
    local hops = 0
    
    -- Prüfe aktuellen Server
    wait(CONFIG.CHECK_DELAY)
    local found, petName, petObj = checkForPets(CONFIG.TARGET_PETS)
    
    if found then
        log("★ " .. petName .. " AUF DIESEM SERVER GEFUNDEN!", "SUCCESS")
        log("Server ID: " .. game.JobId)
        
        if statusCallback then
            statusCallback("✓ " .. petName .. " GEFUNDEN!\nServer: " .. game.JobId:sub(1, 12))
        end
        
        -- Benachrichtigung
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "Gica Hub - Erfolg!";
            Text = petName .. " gefunden!";
            Duration = 10;
        })
        
        return true
    end
    
    -- Nicht gefunden - starte kontinuierliches Hopping
    log("Pets nicht auf diesem Server - starte Server-Hopping...", "WARNING")
    
    if statusCallback then
        statusCallback("Pets nicht gefunden\nStarte Hopping...")
    end
    
    -- Kontinuierlich hoppen bis Pet gefunden
    while true do
        hops = hops + 1
        log(string.format("\n--- Server-Hop #%d ---", hops))
        
        if statusCallback then
            statusCallback(string.format("Hopping...\nVersuch #%d", hops))
        end
        
        wait(CONFIG.HOP_DELAY)
        serverHopWithRetry(statusCallback)
        
        -- Nach erfolgreichem Hop wird das Script neu geladen
        -- und prüft automatisch den neuen Server
        break
    end
    
    return false
end

-- GUI für Kontrolle (optional)
local function createGUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "SecurityTestGUI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = game:GetService("CoreGui")
    
    local Frame = Instance.new("Frame")
    Frame.Size = UDim2.new(0, 300, 0, 200)
    Frame.Position = UDim2.new(0.5, -150, 0.5, -100)
    Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    Frame.BorderSizePixel = 2
    Frame.BorderColor3 = Color3.fromRGB(255, 255, 255)
    Frame.Parent = ScreenGui
    
    local Title = Instance.new("TextLabel")
    Title.Size = UDim2.new(1, 0, 0, 40)
    Title.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    Title.Text = "Gica Hub"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 18
    Title.Parent = Frame
    
    local StatusLabel = Instance.new("TextLabel")
    StatusLabel.Size = UDim2.new(1, -20, 0, 60)
    StatusLabel.Position = UDim2.new(0, 10, 0, 50)
    StatusLabel.BackgroundTransparency = 1
    StatusLabel.Text = "Bereit zum Suchen\nTarget: " .. #CONFIG.TARGET_PETS .. " Pets"
    StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    StatusLabel.Font = Enum.Font.Gotham
    StatusLabel.TextSize = 14
    StatusLabel.TextYAlignment = Enum.TextYAlignment.Top
    StatusLabel.Parent = Frame
    
    local StartButton = Instance.new("TextButton")
    StartButton.Size = UDim2.new(0, 120, 0, 40)
    StartButton.Position = UDim2.new(0.5, -60, 1, -50)
    StartButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    StartButton.Text = "START TEST"
    StartButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    StartButton.Font = Enum.Font.GothamBold
    StartButton.TextSize = 16
    StartButton.Parent = Frame
    
    StartButton.MouseButton1Click:Connect(function()
        StartButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
        StartButton.Text = "LÄUFT..."
        StatusLabel.Text = "Gica Hub aktiv...\nPrüfe Server..."
        
        local function updateStatus(msg)
            StatusLabel.Text = msg
        end
        
        startGicaHub(updateStatus)
    end)
    
    local CloseButton = Instance.new("TextButton")
    CloseButton.Size = UDim2.new(0, 30, 0, 30)
    CloseButton.Position = UDim2.new(1, -35, 0, 5)
    CloseButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    CloseButton.Text = "X"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.TextSize = 18
    CloseButton.Parent = Frame
    
    CloseButton.MouseButton1Click:Connect(function()
        ScreenGui:Destroy()
    end)
    
    -- Draggable
    local dragging, dragInput, dragStart, startPos
    
    Frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = Frame.Position
        end
    end)
    
    Frame.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    game:GetService("UserInputService").InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    game:GetService("RunService").Heartbeat:Connect(function()
        if dragging and dragInput then
            local delta = dragInput.Position - dragStart
            Frame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
end

-- Script Start
log("=== Gica Hub geladen ===")
log("Target-Pets: " .. table.concat(CONFIG.TARGET_PETS, ", "))
log("Kontinuierliches Hopping bis Pet gefunden")

-- Erstelle GUI
createGUI()

-- Optional: Automatisch starten (ohne GUI)
-- startGicaHub()
